<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: gap: https://ssl.gstatic.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://unpkg.com https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdn.jsdelivr.net; font-src 'self' https://cdnjs.cloudflare.com data:; img-src 'self' data: https://*.tile.openstreetmap.org; connect-src 'self' * ws: wss: https://nominatim.openstreetmap.org;">
    
    <title>Taxi Pro CRM</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="stylesheet" href="admin.css">
</head>
<body>

    <!-- LOGIN EKRANI -->
    <div id="admin-login-screen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#1e293b; z-index:9999; display:flex; justify-content:center; align-items:center;">
        <div style="background:white; padding:40px; border-radius:10px; width:350px; text-align:center;">
            <h2 style="margin-bottom:20px; color:#1e293b;">Admin Panel</h2>
            <input type="text" id="login-user" placeholder="Login" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:5px;">
            <input type="password" id="login-pass" placeholder="Parol" style="width:100%; padding:10px; margin-bottom:20px; border:1px solid #ddd; border-radius:5px;">
            <button class="btn btn-primary" style="width:100%;" onclick="adminLogin()">Kirish</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="logo"><i class="fas fa-taxi"></i> TAXI PRO v6.0</div>
        <div class="menu">
            <!-- 1. OPERATSIYA -->
            <div class="menu-item parent" onclick="toggleSubmenu('sub-ops')">
                <span><i class="fas fa-tasks"></i> Operatsiya</span>
                <i class="fas fa-chevron-down arrow"></i>
            </div>
            <div class="submenu" id="sub-ops">
                <div class="menu-item" onclick="openPage('orders')"><i class="fas fa-list-ul"></i> Buyurtmalar</div>
                <div class="menu-item" onclick="openPage('drivers')"><i class="fas fa-car"></i> Haydovchilar</div>
                <div class="menu-item" onclick="openPage('addresses')"><i class="fas fa-map-marked-alt"></i> Manzillar</div>
            </div>
            
            <!-- 2. BOSHQARUV -->
            <div class="menu-item parent" onclick="toggleSubmenu('sub-mng')">
                <span><i class="fas fa-users-cog"></i> Boshqaruv</span>
                <i class="fas fa-chevron-down arrow"></i>
            </div>
            <div class="submenu" id="sub-mng">
                <div class="menu-item" onclick="openPage('clients')"><i class="fas fa-users"></i> Mijozlar</div>
                <div class="menu-item" onclick="openPage('reports')"><i class="fas fa-chart-pie"></i> Hisobotlar</div>
                <div class="menu-item" onclick="openPage('marketing')"><i class="fas fa-chart-line"></i> Marketing</div>
                <div class="menu-item" onclick="openPage('promocodes')"><i class="fas fa-tags"></i> Promokodlar</div>
                <div class="menu-item" onclick="openPage('staff')" id="menu-staff"><i class="fas fa-user-shield"></i> Hodimlar</div>
                <div class="menu-item" onclick="openPage('roles')"><i class="fas fa-user-tag"></i> Rollar va Ruxsatlar</div>
                <div class="menu-item" onclick="openPage('finance')"><i class="fas fa-wallet"></i> Moliya</div>
                <div class="menu-item" onclick="openPage('logs')"><i class="fas fa-history"></i> Tizim Loglari</div>
            </div>

            <!-- 3. KONSTRUKTOR -->
            <div class="menu-item parent" onclick="toggleSubmenu('sub-cons')">
                <span><i class="fas fa-tools"></i> Konstruktor</span>
                <i class="fas fa-chevron-down arrow"></i>
            </div>
            <div class="submenu" id="sub-cons">
                <div class="menu-item" onclick="openPage('regions')"><i class="fas fa-map"></i> Hududlar</div>
                <div class="menu-item" onclick="openPage('services')"><i class="fas fa-taxi"></i> Xizmatlar</div>
                <div class="menu-item" onclick="openPage('tags')"><i class="fas fa-tags"></i> Xizmat Teglari</div>
                <div class="menu-item" onclick="openPage('settings')"><i class="fas fa-tags"></i> Tariflar</div>
            </div>

            <div class="menu-category">Tizim</div>
            <div class="menu-item" onclick="openPage('backups')"><i class="fas fa-database"></i> Zaxira Nusxalar</div>
            <div class="menu-item" onclick="openChangePasswordModal()"><i class="fas fa-key"></i> Parolni o'zgartirish</div>
            <div class="menu-item" onclick="adminLogout()"><i class="fas fa-sign-out-alt"></i> Chiqish</div>
        </div>
    </div>

    <div class="content">

        <!-- [YANGI] HAMKOR KABINETI -->
        <div id="partner_dashboard" class="page-section">
            <div class="header">
                <h2>üìä Hamkor Kabineti</h2>
            </div>

            <!-- [YANGI] TABLAR -->
            <div class="modal-tabs" style="margin-bottom: 20px; background: white; padding: 10px; border-radius: 10px;">
                <button class="tab-btn partner-tab-btn active" onclick="switchPartnerTab('stats')">Statistika</button>
                <button class="tab-btn partner-tab-btn" onclick="switchPartnerTab('drivers')">Haydovchilar</button>
                <button class="tab-btn partner-tab-btn" onclick="switchPartnerTab('orders')">Buyurtmalar</button>
            </div>

            <!-- 1. STATISTIKA BO'LIMI -->
            <div id="pd-tab-stats" class="partner-tab-content">
                <div class="row" style="margin-bottom: 20px;">
                    <div class="col">
                        <div class="card" style="padding: 20px; text-align: center;">
                            <h3 style="color: #64748b; font-size: 14px;">Jami Haydovchilar</h3>
                            <div id="pd-total-drivers" style="font-size: 24px; font-weight: bold; color: #0f172a;">0</div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card" style="padding: 20px; text-align: center;">
                            <h3 style="color: #64748b; font-size: 14px;">Aktiv (Online)</h3>
                            <div id="pd-active-drivers" style="font-size: 24px; font-weight: bold; color: #22c55e;">0</div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card" style="padding: 20px; text-align: center;">
                            <h3 style="color: #64748b; font-size: 14px;">Bugungi Daromad</h3>
                            <div id="pd-today-income" style="font-size: 24px; font-weight: bold; color: #f59e0b;">0 so'm</div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card" style="padding: 20px; text-align: center;">
                            <h3 style="color: #64748b; font-size: 14px;">Joriy Balans</h3>
                            <div id="pd-balance" style="font-size: 24px; font-weight: bold; color: #3b82f6;">0 so'm</div>
                        </div>
                    </div>
                </div>
                
                <!-- Hamkor Sozlamalari -->
                <div class="card" style="margin-bottom: 20px; padding: 20px;">
                    <h3 style="margin-bottom: 15px;">‚öôÔ∏è Sozlamalar</h3>
                    <div class="form-group" style="max-width: 300px;">
                        <label>Mening Ulushim (%):</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="pd-commission" value="0" style="flex: 1;">
                            <button class="btn btn-primary" onclick="saveMyPartnerCommission()">Saqlash</button>
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px;">(Haydovchilardan olinadigan sizning ulushingiz)</small>
                    </div>
                </div>

                <div class="card">
                    <h3>üìâ Daromadlar Dinamikasi (7 kun)</h3>
                    <canvas id="partnerChart" style="width:100%; height:300px"></canvas>
                </div>
            </div>

            <!-- 2. HAYDOVCHILAR BO'LIMI -->
            <div id="pd-tab-drivers" class="partner-tab-content" style="display:none;">
                <div class="header">
                    <h3>Mening Haydovchilarim</h3>
                    <button class="btn btn-primary" onclick="openPartnerAddDriverModal()">+ Haydovchi Qo'shish</button>
                </div>
                <div class="card">
                    <table>
                        <thead><tr><th>F.I.O</th><th>Telefon</th><th>Avto</th><th>Status</th><th>Balans</th><th>Amal</th></tr></thead>
                        <tbody id="pd-drivers-table"></tbody>
                    </table>
                </div>
            </div>

            <!-- 3. BUYURTMALAR BO'LIMI -->
            <div id="pd-tab-orders" class="partner-tab-content" style="display:none;">
                <div class="card">
                    <h3>üìã Buyurtmalar Tarixi</h3>
                    <table>
                        <thead><tr><th>Vaqt</th><th>Haydovchi</th><th>Mijoz (Yashirin)</th><th>Yo'nalish</th><th>Narx</th><th>Status</th></tr></thead>
                        <tbody id="partner-orders-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="regions" class="page-section">
            <div class="header">
                <h2>üó∫ Hududlar (Shaharlar)</h2>
                <button class="btn btn-primary" onclick="openRegionModal()">+ Shahar Qo'shish</button>
            </div>
            <div class="card">
                <table>
                    <thead><tr><th>Nomi</th><th>Markaz</th><th>Radius</th><th>Amal</th></tr></thead>
                    <tbody id="regions-table"></tbody>
                </table>
            </div>
        </div>
        
        <div id="marketing" class="page-section">
            <div class="header">
                <h2>üìà Marketing va Narxlar</h2>
            </div>

            <div class="card" style="margin-bottom: 20px;">
                <h3>‚ö°Ô∏è Avtomatik Dinamik Narx (Auto-Surge)</h3>
                <div style="margin-top: 15px;">
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <label class="switch">
                            <input type="checkbox" id="auto-surge-enable" onchange="saveAutoSurgeSettings()">
                            <span class="slider round"></span>
                        </label>
                        <span style="font-weight: bold;">Avtomatik rejimni yoqish</span>
                    </div>
                    
                    <div class="row" style="margin-top: 15px;">
                        <div class="col form-group">
                            <label>Kutayotgan buyurtmalar (chegara)</label>
                            <input type="number" id="surge-threshold" value="5" onchange="saveAutoSurgeSettings()">
                            <small style="color:#666">Agar shuncha zakaz haydovchisiz qolsa, narx oshadi</small>
                        </div>
                        <div class="col form-group">
                            <label>Narx oshish darajasi</label>
                            <select id="surge-target" onchange="saveAutoSurgeSettings()">
                                <option value="1.2">x1.2 (Yengil)</option>
                                <option value="1.5">x1.5 (O'rtacha)</option>
                                <option value="2.0">x2.0 (Kuchli)</option>
                                <option value="3.0">x3.0 (Maksimal)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top: 10px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <strong>Hozirgi holat: </strong>
                        <span id="current-surge-status" style="font-weight:bold">...</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3>üî• Issiq Zonalar (Heatmap)</h3>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <label class="switch">
                            <input type="checkbox" id="auto-heatmap-enable" onchange="saveAutoSurgeSettings()">
                            <span class="slider round"></span>
                        </label>
                        <span>Avtomatik aniqlash</span>
                    </div>
                    <button class="btn btn-primary" onclick="enableHeatmapMode()">+ Zona Qo'shish</button>
                </div>
                <div id="marketing-map" style="width:100%; height:400px; border-radius:10px; margin-bottom:15px;"></div>
                
                <h4>Aktiv Zonalar:</h4>
                <table style="width:100%; margin-top:10px;">
                    <thead><tr><th>ID</th><th>Lokatsiya</th><th>Amal</th></tr></thead>
                    <tbody id="zones-table"></tbody>
                </table>
            </div>
        </div>

        <div id="promocodes" class="page-section">
            <div class="header">
                <h2>üéü Promokodlar</h2>
                <button class="btn btn-primary" onclick="openPromoModal()">+ Promokod Qo'shish</button>
            </div>
            <div class="card">
                <table>
                    <thead><tr><th>Kod</th><th>Chegirma</th><th>Turi</th><th>Amal</th></tr></thead>
                    <tbody id="promocodes-table"></tbody>
                </table>
            </div>
        </div>

        <div id="services" class="page-section">
            <div class="header">
                <h2>üöñ Xizmat Turlari</h2>
                <button class="btn btn-primary" onclick="openServiceModal()">+ Xizmat Qo'shish</button>
            </div>
            <div class="card">
                <table>
                    <thead><tr><th>Nomi</th><th>Teg (Kategoriya)</th><th>Icon</th><th>Amal</th></tr></thead>
                    <tbody id="services-table"></tbody>
                </table>
            </div>
        </div>
        
        <div id="orders" class="page-section active">
            <div class="header">
                <div class="page-title"><h2>Buyurtmalar</h2></div>
                <button class="btn btn-primary" onclick="openModal()">+ Yangi Zakaz</button>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Vaqt</th>
                            <th>Mijoz</th>
                            <th>Yo'nalish</th>
                            <th>Izoh</th>
                            <th>Status</th>
                            <th>Amal</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table"></tbody>
                </table>
            </div>
        </div>

        <div id="drivers" class="page-section">
            <div class="header">
                <div class="page-title"><h2>Haydovchilar</h2></div>
                <button class="btn btn-primary" onclick="openNewDriverModal()">+ Haydovchi Qo'shish</button>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>F.I.O</th>
                            <th>Telefon</th>
                            <th>Avto</th>
                            <th>Status</th>
                            <th>Amal</th>
                        </tr>
                    </thead>
                    <tbody id="drivers-table"></tbody>
                </table>
            </div>
        </div>

        <div id="addresses" class="page-section">
            <div class="header">
                <div class="page-title"><h2>Manzillar</h2></div>
                <button class="btn btn-primary" onclick="openNewAddressModal()">+ Xaritadan Qo'shish</button>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Nomi</th>
                            <th>Manzil</th>
                            <th>Kordinata</th>
                            <th>Amal</th>
                        </tr>
                    </thead>
                    <tbody id="addresses-table"></tbody>
                </table>
            </div>
        </div>

<div id="clients" class="page-section">
            <div class="header">
                <div class="page-title"><h2>Mijozlar Ro'yxati</h2></div>
                <button class="btn btn-outline" onclick="loadClients()">üîÑ Yangilash</button>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Telefon Raqam</th>
                            <th>Kirgan Vaqti</th>
                        </tr>
                    </thead>
                    <tbody id="clients-table">
                        </tbody>
                </table>
            </div>
        </div>
        <div id="reports" class="page-section">
            <div class="header">
                <h2>üìä Moliyaviy Hisobotlar</h2>
            </div>
            <div class="card">
                <canvas id="incomeChart" style="width:100%; height:400px"></canvas>
            </div>
        </div>
        <div id="settings" class="page-section">
            <div class="header">
                <div class="page-title"><h2>‚öôÔ∏è Tariflar Konstruktori</h2></div>
                <button class="btn btn-primary" onclick="openTariffModal()">+ Yangi Tarif</button>
            </div>

            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Nomi</th>
                            <th>Min. Narx</th>
                            <th>Km Narxi</th>
                            <th>Tekin Km</th>
                            <th>Kutish (so'm/daq)</th>
                            <th>Amal</th>
                        </tr>
                    </thead>
                    <tbody id="tariffs-table"></tbody>
                </table>
            </div>
        </div>

        <div id="staff" class="page-section">
            <div class="header">
                <h2>üõ° Hodimlar va Rollar</h2>
                <button class="btn btn-primary" onclick="openStaffModal()">+ Hodim Qo'shish</button>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>F.I.O</th>
                            <th>Login</th>
                            <th>Rol</th>
                            <th>Status</th>
                            <th>Oxirgi Kirish</th>
                            <th>Amal</th>
                        </tr>
                    </thead>
                    <tbody id="staff-table"></tbody>
                </table>
            </div>
        </div>

        <div id="roles" class="page-section">
            <div class="header">
                <h2>üîê Rollar va Ruxsatlar</h2>
                <button class="btn btn-primary" onclick="openRoleModal()">+ Rol Qo'shish</button>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr><th>Rol Nomi (Slug)</th><th>Ko'rsatiladigan Nom</th><th>Ruxsatlar</th><th>Amal</th></tr>
                    </thead>
                    <tbody id="roles-table"></tbody>
                </table>
            </div>
        </div>

        <div id="finance" class="page-section">
            <div class="header">
                <h2>üí∞ Moliya va Tranzaksiyalar</h2>
                <div id="partner-balance-display" style="font-size: 18px; font-weight: bold; color: green;"></div>
            </div>
            
            <!-- [YANGI] Kompaniya Ulushi Sozlamasi -->
            <div class="card" id="company-commission-card" style="margin-bottom: 20px; padding: 20px; display: flex; align-items: center; gap: 20px;">
                <h3 style="margin:0;">üè¢ Kompaniya Ulushi:</h3>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="number" id="company-commission" value="0" style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    <span style="font-weight: bold;">%</span>
                    <button class="btn btn-primary" onclick="saveCompanyCommission()">Saqlash</button>
                </div>
                <small style="color: #666;">(Barcha buyurtmalardan olinadigan ulush)</small>
            </div>

            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Sana</th>
                            <th>Buyurtma ID</th>
                            <th>Haydovchi</th>
                            <th>Jami Summa</th>
                            <th>Hamkor Ulushi</th>
                            <th>Kompaniya Ulushi</th>
                        </tr>
                    </thead>
                    <tbody id="finance-table"></tbody>
                </table>
            </div>
        </div>

        <div id="logs" class="page-section">
            <div class="header">
                <h2>üìú Tizim Loglari</h2>
                <button class="btn btn-outline" onclick="loadLogs()">üîÑ Yangilash</button>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Vaqt</th>
                            <th>Foydalanuvchi</th>
                            <th>Amal</th>
                            <th>Tafsilotlar</th>
                        </tr>
                    </thead>
                    <tbody id="logs-table"></tbody>
                </table>
            </div>
        </div>

        <div id="backups" class="page-section">
            <div class="header">
                <h2>üíæ Zaxira Nusxalar (Backups)</h2>
                <button class="btn btn-outline" onclick="loadBackups()">üîÑ Yangilash</button>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Fayl Nomi</th>
                            <th>Hajmi</th>
                            <th>Sana</th>
                            <th>Amal</th>
                        </tr>
                    </thead>
                    <tbody id="backups-table"></tbody>
                </table>
            </div>
        </div>

        <div id="tags" class="page-section">
            <div class="header">
                <h2>üè∑ Xizmat Teglari (Kategoriyalar)</h2>
                <button class="btn btn-primary" onclick="openTagModal()">+ Teg Qo'shish</button>
            </div>
            <div class="card">
                <table>
                    <thead><tr><th>Nomi</th><th>Amal</th></tr></thead>
                    <tbody id="tags-table"></tbody>
                </table>
            </div>
        </div>
    </div> <div id="tariffModal" class="modal">
        <div class="modal-content" style="width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header"><h2>Tarif Sozlamalari</h2><span class="close-btn" onclick="closeTariffModal()">√ó</span></div>
            <input type="hidden" id="t-edit-id">
            
            <div class="modal-tabs">
                <button class="tab-btn active" onclick="switchTariffTab(0)">Asosiy</button>
                <button class="tab-btn" onclick="switchTariffTab(1)">Narxlar</button>
                <button class="tab-btn" onclick="switchTariffTab(2)">Vaqt va Kutish</button>
                <button class="tab-btn" onclick="switchTariffTab(3)">Qo'shimcha</button>
            </div>

            <div class="modal-body">
                
                <div id="t-tab-0" class="tab-content active">
                    <div class="form-group"><label>Tarif Nomi</label><input type="text" id="t-nomi" placeholder="Masalan: Standart"></div>
                    <div class="row">
                        <div class="col form-group"><label>Hudud (Region)</label><select id="t-region-select"></select></div>
                        <div class="col form-group"><label>Xizmat (Slujba)</label><select id="t-service-select"></select></div>
                    </div>
                    <div class="row">
                        <div class="col form-group"><label>Guruh</label><input type="text" id="t-group"></div>
                        <div class="col form-group"><label>Yashirin Tarif</label><input type="checkbox" id="t-hidden"></div>
                    </div>
                </div>

                <div id="t-tab-1" class="tab-content">
                    <div class="row">
                        <div class="col form-group"><label>Minimal Narx</label><input type="number" id="t-min-narx" value="5000"></div>
                        <div class="col form-group"><label>Tekin Km (Min. narx ichida)</label><input type="number" id="t-tekin-km" value="2"></div>
                    </div>
                    <div class="row">
                        <div class="col form-group"><label>1 Km Narxi</label><input type="number" id="t-km-narxi" value="2000"></div>
                        <div class="col form-group"><label>Ilk Km Narxi (Qo'shimcha)</label><input type="number" id="t-first-km-narxi" value="0"></div>
                    </div>
                    <div class="row">
                        <div class="col form-group"><label>Posadka (O'tirish)</label><input type="number" id="t-posadka" value="0"></div>
                        <div class="col form-group"><label>Nuqta Narxi (To'xtash)</label><input type="number" id="t-point-narxi" value="0"></div>
                    </div>
                </div>

                <div id="t-tab-2" class="tab-content">
                    <h4>Yo'l vaqti</h4>
                    <div class="row">
                        <div class="col form-group"><label>Vaqt Narxi (so'm)</label><input type="number" id="t-vaqt-narxi" value="0"></div>
                        <div class="col form-group"><label>Tekin Vaqt (birlik)</label><input type="number" id="t-tekin-vaqt" value="0"></div>
                        <div class="col form-group"><label>Vaqt Birligi (daq)</label><input type="number" id="t-vaqt-birligi" value="1"></div>
                    </div>
                    <hr>
                    <h4>Kutish (Boshlanishidan oldin)</h4>
                    <div class="row">
                        <div class="col form-group"><label>Kutish Narxi (so'm/daq)</label><input type="number" id="t-kutish-narxi" value="500"></div>
                        <div class="col form-group"><label>Tekin Kutish (daq)</label><input type="number" id="t-tekin-kutish" value="3"></div>
                    </div>
                    <hr>
                    <h4>To'xtab turish (Probka/Kutish)</h4>
                    <div class="row">
                        <div class="col form-group"><label>To'xtash Narxi (so'm/daq)</label><input type="number" id="t-stop-narxi" value="0"></div>
                        <div class="col form-group"><label>Tekin To'xtash (daq)</label><input type="number" id="t-tekin-stop" value="0"></div>
                    </div>
                </div>

                <div id="t-tab-3" class="tab-content">
                    <div class="row">
                        <div class="col form-group"><label>To'xtash Tezligi (km/h)</label><input type="number" id="t-stop-speed" value="5"></div>
                        <div class="col form-group"><label>Svetofor Pauzasi (sek)</label><input type="number" id="t-traffic-wait" value="60"></div>
                    </div>
                    <div class="row">
                        <div class="col form-group"><label>Yaxlitlash (so'm)</label><input type="number" id="t-round-to" value="100"></div>
                        <div class="col form-group"><label>Yaxlitlash Turi</label><select id="t-round-method"><option value="math">Matematik</option><option value="up">Yuqoriga</option><option value="down">Pastga</option></select></div>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="t-auto-stop" checked> Avto To'xtashni Aniqlash</label><br>
                        <label><input type="checkbox" id="t-round-live"> Narxni Jonli Yaxlitlash</label><br>
                        <label><input type="checkbox" id="t-show-min" checked> Minimal Narxni Ko'rsatish</label>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="saveTariff()">Saqlash</button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <div id="newOrderModal" class="modal">
        <div class="modal-content" style="width: 500px;">
            <div class="modal-header"><h2>Buyurtma</h2><span class="close-btn" onclick="closeModal()">√ó</span></div>
            <div class="modal-body">
                <input type="hidden" id="o-edit-id">
                <div class="form-group"><label>Telefon</label><input type="text" id="m-phone" placeholder="+998"></div>
                <div class="form-group"><label>Mijoz Ismi</label><input type="text" id="m-name"></div>
                <div class="row">
                    <div class="col form-group">
                        <label>Qayerdan</label><input type="text" id="m-from" placeholder="Adres..." autocomplete="off">
                    </div>
                    <div class="col form-group">
                        <label>Qayerga</label><input type="text" id="m-to" placeholder="Adres..." autocomplete="off">
                    </div>
                </div>
                <div class="form-group"><label>Izoh</label><input type="text" id="m-comment"></div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeModal()">Bekor qilish</button>
                    <button class="btn btn-primary" onclick="createOrder()">Saqlash</button>
                </div>
            </div>
        </div>
    </div>

    <div id="viewOrderModal" class="modal">
        <div class="modal-content" style="width: 500px;">
            <div class="modal-header"><h2>üì¶ Buyurtma Tafsilotlari</h2><span class="close-btn" onclick="closeViewOrderModal()">√ó</span></div>
            <div class="modal-body">
                <div class="row"><div class="col"><strong>Mijoz:</strong></div><div class="col" id="view-o-name"></div></div>
                <div class="row" style="margin-top:10px"><div class="col"><strong>Telefon:</strong></div><div class="col" id="view-o-phone"></div></div>
                <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
                <div class="form-group">
                    <label>üìç Marshrut:</label>
                    <div style="background: #f8fafc; padding: 10px; border-radius: 8px;">
                        <div style="color:green">A: <span id="view-o-from"></span></div>
                        <div id="view-o-stops"></div>
                        <div style="margin-top:5px; color:red">B: <span id="view-o-to"></span></div>
                    </div>
                </div>
                <div class="form-group"><label>üìù Izoh:</label><div id="view-o-comment" style="font-style: italic; color: #666;"></div></div>
                <div class="row"><div class="col"><strong>Vaqt:</strong> <span id="view-o-time"></span></div><div class="col"><strong>Status:</strong> <span id="view-o-status" class="badge"></span></div></div>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="closeViewOrderModal()">Yopish</button></div>
        </div>
    </div>

    <div id="newDriverModal" class="modal">
        <div class="modal-content" style="width: 600px;">
            <div class="modal-header"><h2>Haydovchi Anketa</h2><span class="close-btn" onclick="closeDriverModal()">√ó</span></div>
            <div class="modal-tabs">
                <button class="tab-btn active" onclick="switchTab(0)">1. Shaxsiy</button>
                <button class="tab-btn" onclick="switchTab(1)">2. Avtomobil</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="d-edit-id">
                <div id="tab-0" class="tab-content active">
                    <div class="row">
                        <div class="col form-group"><label>Ism</label><input type="text" id="d-firstname"></div>
                        <div class="col form-group"><label>Familiya</label><input type="text" id="d-lastname"></div>
                    </div>
                    <div class="form-group"><label>Telefon</label><input type="text" id="d-phone" value="+998"></div>
                    <div class="form-group"><label>Hamkor (Partner)</label><select id="d-partner"><option value="">Kompaniya (O'zi)</option></select></div>
                    <div class="form-group"><label>Hisob-kitob guruhi</label><select id="d-calc-group"><option value="">Tanlang...</option></select></div>
                </div>
                <div id="tab-1" class="tab-content">
                    <div class="row">
                        <div class="col form-group"><label>Marka</label><select id="d-brand"><option>Chevrolet Cobalt</option><option>Chevrolet Gentra</option><option>Nexia 3</option></select></div>
                        <div class="col form-group"><label>Model</label><input type="text" id="d-model"></div>
                    </div>
                    <div class="row">
                        <div class="col form-group"><label>Raqam</label><input type="text" id="d-plate"></div>
                        <div class="col form-group"><label>Rang</label><select id="d-color"><option>Oq</option><option>Qora</option><option>Nam</option></select></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveDriver()">Saqlash</button>
            </div>
        </div>
    </div>

    <div id="newAddressModal" class="modal">
        <div class="modal-content" style="width: 700px;">
            <div class="modal-header"><h2>Xaritadan joy tanlang</h2><span class="close-btn" onclick="closeAddressModal()">√ó</span></div>
            <div id="map" style="width:100%; height:350px"></div>
            <div class="modal-body">
                <input type="hidden" id="addr-edit-id">
                <input type="hidden" id="addr-lat"><input type="hidden" id="addr-lng">
                <div class="row">
                    <div class="col form-group"><label>Joy Nomi</label><input type="text" id="addr-name"></div>
                    <div class="col form-group"><label>Manzil</label><input type="text" id="addr-full" readonly></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveAddress()">Saqlash</button>
            </div>
        </div>
    </div>

    <div id="drivers" class="page-section">
    <div class="header">
        <div class="page-title"><h2>Haydovchilar</h2></div>
        <button class="btn btn-primary" onclick="openNewDriverModal()">+ Haydovchi Qo'shish</button>
    </div>
    <div class="card">
        <table>
            <thead>
                <tr>
                    <th>F.I.O</th>
                    <th>Telefon</th>
                    <th>Avto</th>
                    <th>Status</th>
                    <th>Balans</th> <th>Amal</th>
                </tr>
            </thead>
            <tbody id="drivers-table"></tbody>
        </table>
    </div>
</div>

<div id="balanceModal" class="modal">
    <div class="modal-content" style="width: 400px;">
        <div class="modal-header"><h2>üí∞ Balans Boshqaruvi</h2><span class="close-btn" onclick="closeBalanceModal()">√ó</span></div>
        <input type="hidden" id="bal-driver-id">
        <input type="hidden" id="bal-type"> <!-- driver yoki partner -->
        <div class="form-group">
            <label>Foydalanuvchi:</label>
            <b id="bal-name" style="font-size:18px">...</b>
        </div>
        <div class="form-group">
            <label>Amal turi</label>
            <select id="bal-action"><option value="add">‚ûï To'ldirish</option><option value="deduct">‚ûñ Yechib olish (Jarima)</option></select>
        </div>
        <div class="form-group">
            <label>Summa (so'm)</label>
            <input type="number" id="bal-amount" placeholder="Masalan: 50000">
        </div>
        <div class="form-group"><label>Izoh</label><input type="text" id="bal-comment" placeholder="Sababi..."></div>
        <div class="modal-footer">
            <button class="btn btn-primary" style="width:100%" onclick="submitBalance()">Bajarish</button>
        </div>
    </div>
</div>

    <script src="admin.js"></script>

    <div id="regionModal" class="modal">
        <div class="modal-content" style="width: 600px;">
            <div class="modal-header"><h2>Shahar Qo'shish</h2><span class="close-btn" onclick="closeRegionModal()">√ó</span></div>
            <div id="region-map" style="width:100%; height:300px; margin-bottom:15px; border-radius:8px;"></div>
            <div class="row">
                <div class="col form-group"><label>Shahar Nomi</label><input type="text" id="reg-name"></div>
                <div class="col form-group"><label>Radius (km)</label><input type="number" id="reg-radius" value="10"></div>
            </div>
            <input type="hidden" id="reg-lat"><input type="hidden" id="reg-lng">
            <button class="btn btn-primary" style="width:100%" onclick="saveRegion()">Saqlash</button>
        </div>
    </div>
    
    <div id="serviceModal" class="modal">
        <div class="modal-content" style="width: 400px;">
            <div class="modal-header"><h2>Xizmat Turi</h2><span class="close-btn" onclick="closeServiceModal()">√ó</span></div>
            <div class="form-group"><label>Nomi (Masalan: Start)</label><input type="text" id="srv-name"></div>
            <div class="form-group"><label>Teg (Kategoriya)</label><select id="srv-tag"><option value="">Tanlang...</option></select></div>
            <div class="form-group"><label>Icon (Rasm nomi)</label><select id="srv-icon"><option value="car.png">car.png (Oddiy)</option><option value="vip.png">vip.png (Qora)</option></select></div>
            <button class="btn btn-primary" style="width:100%" onclick="saveService()">Saqlash</button>
        </div>
    </div>

    <div id="staffModal" class="modal">
        <div class="modal-content" style="width: 400px;">
            <div class="modal-header"><h2>Hodim Qo'shish</h2><span class="close-btn" onclick="closeStaffModal()">√ó</span></div>
            <input type="hidden" id="st-edit-id">
            <div class="form-group"><label>F.I.O</label><input type="text" id="st-name"></div>
            <div class="form-group"><label>Login</label><input type="text" id="st-user"></div>
            <div class="form-group"><label>Parol</label><input type="text" id="st-pass"></div>
            <div class="form-group"><label>Rol</label>
                <select id="st-role">
                    <!-- JS orqali to'ldiriladi -->
                </select>
            </div>
            <div class="form-group" id="st-commission-box" style="display:none"><label>Hamkor Ulushi (%)</label><input type="number" id="st-commission" value="0"></div>
            
            <div class="form-group">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <input type="checkbox" id="st-active" checked style="width:auto;"> 
                    Aktiv (Tizimga kira oladi)
                </label>
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="saveStaff()">Saqlash</button>
        </div>
    </div>
    
    <div id="promoModal" class="modal">
        <div class="modal-content" style="width: 400px;">
            <div class="modal-header"><h2>Promokod Qo'shish</h2><span class="close-btn" onclick="closePromoModal()">√ó</span></div>
            <div class="form-group"><label>Kod (Masalan: TAXI2024)</label><input type="text" id="pr-code"></div>
            <div class="form-group"><label>Chegirma Miqdori</label><input type="number" id="pr-amount"></div>
            <div class="form-group"><label>Turi</label><select id="pr-type"><option value="percent">Foiz (%)</option><option value="fixed">Summa (so'm)</option></select></div>
            <button class="btn btn-primary" style="width:100%" onclick="savePromo()">Saqlash</button>
        </div>
    </div>

    <div id="tagModal" class="modal">
        <div class="modal-content" style="width: 400px;">
            <div class="modal-header"><h2>Teg Qo'shish</h2><span class="close-btn" onclick="closeTagModal()">√ó</span></div>
            <div class="form-group"><label>Nomi (Masalan: Taksi)</label><input type="text" id="tag-name"></div>
            <button class="btn btn-primary" style="width:100%" onclick="saveTag()">Saqlash</button>
        </div>
    </div>
    
    <div id="partnerModal" class="modal">
        <div class="modal-content" style="width: 700px;">
            <div class="modal-header"><h2>Hamkor Qo'shish</h2><span class="close-btn" onclick="document.getElementById('partnerModal').style.display='none'">√ó</span></div>
            <input type="hidden" id="pt-edit-id">
            <div class="row">
                <div class="col form-group"><label>Ism</label><input type="text" id="pt-firstname"></div>
                <div class="col form-group"><label>Familiya</label><input type="text" id="pt-lastname"></div>
            </div>
            <div class="form-group"><label>Partnyor Nomi (Brend)</label><input type="text" id="pt-brand" placeholder="Haydovchida ko'rinadi"></div>
            <div class="row">
                <div class="col form-group"><label>Telefon</label><input type="text" id="pt-phone" value="+998"></div>
                <div class="col form-group"><label>MChJ STIR (INN)</label><input type="text" id="pt-inn"></div>
            </div>
            <div class="row">
                <div class="col form-group"><label>Pasport (Seriya)</label><input type="text" id="pt-passport" placeholder="AB1234567"></div>
                <div class="col form-group"><label>JSHSHIR</label><input type="text" id="pt-jshshir"></div>
            </div>
            <div class="row">
                <div class="col form-group"><label>Login</label><input type="text" id="pt-user"></div>
                <div class="col form-group"><label>Parol</label><input type="text" id="pt-pass"></div>
            </div>
            <div class="form-group"><label>Hamkor Ulushi (%)</label><input type="number" id="pt-commission" value="10"></div>
            <button class="btn btn-primary" style="width:100%" onclick="savePartner()">Saqlash</button>
        </div>
    </div>

    <div id="roleModal" class="modal">
        <div class="modal-content" style="width: 500px;">
            <div class="modal-header"><h2>Rol Qo'shish</h2><span class="close-btn" onclick="closeRoleModal()">√ó</span></div>
            <div class="row">
                <div class="col form-group"><label>Slug (ID)</label><input type="text" id="r-slug" placeholder="admin, partner..."></div>
                <div class="col form-group"><label>Nom</label><input type="text" id="r-name" placeholder="Administrator..."></div>
            </div>
            <div class="form-group"><label>Ruxsatlar (Bo'limlar)</label>
                <div id="r-permissions" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <label><input type="checkbox" value="orders"> Buyurtmalar</label>
                    <label><input type="checkbox" value="drivers"> Haydovchilar</label>
                    <label><input type="checkbox" value="clients"> Mijozlar</label>
                    <label><input type="checkbox" value="reports"> Hisobotlar</label>
                    <label><input type="checkbox" value="settings"> Sozlamalar</label>
                    <label><input type="checkbox" value="marketing"> Marketing</label>
                    <label><input type="checkbox" value="staff"> Hodimlar</label>
                    <label><input type="checkbox" value="roles"> Rollar</label>
                    <label><input type="checkbox" value="finance"> Moliya</label>
                </div>
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="saveRole()">Saqlash</button>
        </div>
    </div>

    <div id="changePasswordModal" class="modal">
        <div class="modal-content" style="width: 400px;">
            <div class="modal-header"><h2>Parolni O'zgartirish</h2><span class="close-btn" onclick="closeChangePasswordModal()">√ó</span></div>
            <div class="form-group"><label>Eski Parol</label><input type="password" id="cp-old"></div>
            <div class="form-group"><label>Yangi Parol</label><input type="password" id="cp-new"></div>
            <button class="btn btn-primary" style="width:100%" onclick="submitChangePassword()">Saqlash</button>
        </div>
    </div>

</body>
</html>